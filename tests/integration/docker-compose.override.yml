# Override for CVAT integration tests.
#
# Adds MinIO, cvat_ui and traefik. Disables the analytics pipeline.
# All image versions come from the checked-out CVAT submodule tag.
#
# INTEGRATION_USER is set by integration_up.sh (defaults to "default")
# and used as a container-name prefix to avoid clashes between users.
#
# Traefik routes both API and UI on a single dynamic port (CVAT_PORT):
#   /api/, /static/, /admin, /django-rq  ->  cvat_server
#   everything else                      ->  cvat_ui
#
# !override on traefik ports replaces the base 8080/8090 bindings
# so only the dynamic CVAT_PORT is exposed (requires Compose v2.24.6+).

services:
  cvat_db:
    container_name: ${INTEGRATION_USER:-default}-cvat_db

  cvat_redis_inmem:
    container_name: ${INTEGRATION_USER:-default}-cvat_redis_inmem

  cvat_redis_ondisk:
    container_name: ${INTEGRATION_USER:-default}-cvat_redis_ondisk

  cvat_opa:
    container_name: ${INTEGRATION_USER:-default}-cvat_opa

  cvat_server:
    container_name: ${INTEGRATION_USER:-default}-cvat_server
    environment:
      CVAT_ANALYTICS: 0

  cvat_worker_import:
    container_name: ${INTEGRATION_USER:-default}-cvat_worker_import

  cvat_worker_chunks:
    container_name: ${INTEGRATION_USER:-default}-cvat_worker_chunks

  traefik:
    container_name: ${INTEGRATION_USER:-default}-traefik
    ports: !override
      - "${CVAT_PORT:-8080}:8080"

  cvat_ui:
    container_name: ${INTEGRATION_USER:-default}-cvat_ui

  cveta2-minio:
    container_name: ${INTEGRATION_USER:-default}-cveta2-minio
    image: minio/minio:latest
    restart: unless-stopped
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    command: server /data --console-address ":9001"
    ports:
      - "${MINIO_PORT:-9000}:9000"
      - "${MINIO_CONSOLE_PORT:-9001}:9001"
    volumes:
      - cveta2-minio-data:/data
    networks:
      - cvat
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 5s
      timeout: 5s
      retries: 5

volumes:
  cveta2-minio-data:
